# User Based Scalability 

단일 서버부터 시작해서 사용자 수에 따른 규모 확장성에 대해 알아보자 

## Single Server 

웹, 앱, 데이터베이스, 캐시 등이 전부 서버 한 대에서 실행되는 경우를 생각해보자 

![img.png](img.png)

1. 사용자는 도메인 이름(ex.www.example.com)을 이용해서 웹 사이트에 접속한다. 이때 DNS에 질의하여 IP 주소로 변환하는 과정이 필요하다. 
2. DNS 조회 결과로 IP 반환된다. (이 주소는 웹 서버의 주소) 
3. 해당 IP 주소로 HTTP 요청이 전달된다. 
4. 요청을 받은 웹 서버는 HTML 페이지나 JSON 형태의 응답을 반환한다. 

> DNS는 보통 제3 사업자가 제공하는 유료 서비스 이용(시스템의 일부가 아님)

## Database 

사용자 수가 늘면 서버 하나로는 충분하지 않아 여러 서버를 두어야 한다.
- 하나는 웹/모바일 트래픽 처리 용도 (웹/모바일 트래픽 처리 서버 - 웹 계층)
- 다른 하나는 데이터베이스 용도 (데이터베이스 서버 - 데이터 계층)

> 웹/모바일 트래픽 서버와 데이터베이스 서버를 분리하면 각각을 독립적으로 확장해 나갈 수 있다. 

![img_1.png](img_1.png)

### 어떤 Database를 사용할 것인가? 

전동적인 관계형 데이터베이스와 비-관계형 데이터베이스 사이에서 고를 수 있다. 

#### 관계형 데이터베이스 

관계형 데이터베이스는 관계형 데이터베이스 관리 시스템(RDBMS)이라고도 부른다. RDBMS 가운데 가장 유명한 것은 MySQL, Oracle, PostgreSQL 등이 있다. 

- 관계형 데이터베이스는 자료를 row, column으로 표현한다. SQL을 사용하면 여러 데이블에 있는 데이터를 그 관계에 따라 JOIN하여 합칠 수 있다. 

#### 비-관계형 데이터베이스 

비-관계형 데이터베이스는 NoSQL이라고도 부른다. 대표적인 것으로는 HBase, Amazon DynamoDB 등이 있다. 

- NoSQL은 4부류로 나눌 수 있는데, 키-값 저장소, 그래프 저장소, 칼럼 저장소, 문서 저장소이다. 
- 비-관계형 데이터베이스는 일반적으로 조인 연산은 지원하지 않는다.

> 비-관계형 데이터베이스가 적합한 경우 
> - 아주 낮은 응답 지연시간(latency)이 요구되는 경우
> - 다루는 데이터가 비정형(unstructured)이라 관계형 데이터가 아닌 경우
> - 데이터(JSON, YAML, XML 등)를 직렬화하거나(serialize) 역직렬화(deserialize)할 수 있기만 하면 되는 경우
> - 아주 많은 양의 데이터를 저장할 필요가 있는 경우 

## 수직적 규모 확장 vs 수평적 규모 확장 

- **수직적 규모 확장** : scale up, 서버에 고사양 자원(CPU, RAM 등)을 추가 
  - 서버로 유입되는 트래픽 양이 적을 때 좋은 선택 
  - 가장 큰 장점이 단순함
  - 심각한 단점은 확장에 한계가 있으며, 장애에 대한 자동복구(failover)나 다중화(redundancy) 방안을 제시하지 않음 
    - 따라서, **서버에 장애가 발생하면 웹사이트/앱이 완전히 중단** 
- **수평적 규모 확장** : scale out, 더 많은 서버를 추가하여 성능을 개선 
  - **대규모 애플리케이션을 지원**하는 데는 수평적 규모 확장법이 적절 
  - 너무 많은 사용자가 접속하여 웹 서버가 한계 상황에 도달하게 되면 응답 속도가 너무 느려지거나 서버 접속이 불가능해질 수 있다. 
    - 이때, **부하 분산기 또는 로드밸런서를 도입**하는 것이 최선 

## Load Balancer 

로드 밸런서는 부하 분산 집합에 속한 웹 서버들에게 트래픽 부하를 고르게 분산하는 역할을 한다. 

![img_2.png](img_2.png)

- 그림의 **Public IP는 로드 밸런서의 Public IP 주소**이다. 
  - 따라서 웹 서버는 Client의 접속을 직접 처리하지 않는다. 
  - 더 나은 보안을 위해 **서버 간 통신에는 Private IP 주소가 이용**된다. 
  - **로드 밸런서는 웹 서버와 통신하기 위해 Private IP 주소 이용** 
- 그림과 같이 부하 분산 집합에 서버를 추가하면 장애를 자동복구하지 못하는 문제(no failover)가 해소되며, 웹 계층의 가용성(availability)가 향상된다. 
  - 서버 1이 다운되면(offline) 모든 트래픽은 서버 2로 전송 (웹 사이트 전체가 다운되는 일 방지)
    - 부하를 나누기 위해 서버를 추가하는 경우도 있음 
  - 만약 웹 사이트로 유입되는 트래픽이 가파르게 증가하면 2대의 서버로 트래픽을 감당할 수 없는 시점이 오게 된다.
    - 이때 웹 서버 계층에 서버를 추가하기만 하면, 로드 밸런서가 자동적으로 트래픽 분산한다. 

> Private IP 주소는 같은 네트워크에 속한 서버 사이의 통신에만 쓰일 수 있는 IP 주소, 인터넷을 통해서는 접속할 수 없음 

이제 하나뿐인 데이터베이스 서버의 장애 자동 복구와 다중화를 지원할 수 있도록 구성해 보자

## 데이터베이스 다중화 

![img_3.png](img_3.png)

데이터베이스 다중화는 보통 **주(master)-부(slave) 관계를 설정**하고 **데이터 원본은 주 서버**에, **사본은 부 서버에 저장**하는 방식이다. 

- 쓰기 연산은 마스터에서만 지원 
  - insert, update, delete 등 데이터베이스를 변경하는 명령어들을 마스터로만 전달되어야 한다. 
- 부 데이터베이스는 주 데이터베이스로부터 그 사본을 전달받으며, 읽기 연산만을 지원 

> 대부분의 애플리케이션은 **읽기 연산의 비중**이 쓰기 연산보다 훨씬 **높다.** 
> - 부 데이터베이스의 수 >= 주 데이터베이스 수 

### 데이터베이스 다중화의 장점 

- 더 나은 성능 : 모든 데이터 변경 연산 - 주 데이터베이스 / 읽기 연산 - 부 데이터베이스, 병렬로 처리될 수 있는 질의(query) 수가 늘어나 성능 향상 
- 안정성(reliability) : 데이터베이스 서버 일부가 파괴되어도 데이터 보존 가능(데이터를 지역적으로 떨어진 여러 장소에 다중화시켜 놓을 수 있기 때문)
- 가용성(availability) : 데이터를 여러 지역에 복제해 둠으로써, 하나의 데이터베이스 서버에 장애가 발생해도 다른 서버에 있는 데이터를 가져와 계속 서비스 가능 

#### 만약 데이터베이스 서버 중 하나가 다운되면? 

1. 부 서버가 한 대 뿐인데, 다운된 경우 : 읽기 연산이 한시적으로 모두 주 데이터베이스로 전달, 즉시 새로운 부 데이터베이스 서버가 장애 서버를 대체
2. 부 서버가 여러 대인 경우 : 읽기 연산이 나머지 부 데이터베이스 서버로 분산, 새로운 부 데이터베이스 서버가 장애 서버를 대체 
3. 주 서버가 다운된 경우 : 한 대의 부 데이터베이스 서버만 있는 경우 **해당 부 데이터베이스가 새로운 주 서버**가 되며, 모든 데이터베이스 연산은 일시적으로 새로운 주 서버에서 수행, 그리고 **새로운 부 서버가 추가**

> 만약 부 서버에 보관된 데이터가 최신 상태가 아니라면? 
> 
> 없는 데이터는 복구 스크립트를 돌려서 추가해야 한다. 
> 다중 마스터나 원형 다중화 방법도 있다. 하지만 훨씬 복잡하다. 

#### DB 다중화를 고려한 설계 

![img_4.png](img_4.png)

- 동작 과정 
  - 사용자는 DNS로부터 LB의 Public IP 받기 
  - 사용자는 해당 Public IP를 사용해 LB에 접속 
  - HTTP 요청은 서버 1이나 서버 2로 전달 
  - 웹 서버는 사용자 데이터를 부 서버에서 읽기 
  - 웹 서버는 데이터 변경 연산을 주 서버로 전달

이제 응답시간(latency)를 개선해보자 



